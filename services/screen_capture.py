"""
–ú–æ–¥—É–ª—å –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å –ø–æ–º–æ—â—å—é LLM.

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ø–∞–∫–µ—Ç–∞ `services` –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥—Ä—É–≥–∏–º –º–æ–¥—É–ª—è–º —ç—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞.

–î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ `mss` –∏ `Pillow`. –í —Ü–∏–∫–ª–µ
—Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –¥–µ–ª–∞–µ—Ç —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞, –ø–µ—Ä–µ–¥–∞—ë—Ç –µ–≥–æ –≤ —Ñ—É–Ω–∫—Ü–∏—é
–æ–ø–∏—Å–∞–Ω–∏—è –∏ –∑–∞—Ç–µ–º –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –º–æ–¥–µ–ª–∏. –û–∑–≤—É—á–∏–≤–∞–µ—Ç
–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –ø–æ–º–æ—â—å—é —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–æ–¥—É–ª—è `tts_silero`.

–§—É–Ω–∫—Ü–∏—è `describe_screen` –ø–æ–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–æ–π. –ï—ë —Å–ª–µ–¥—É–µ—Ç
–∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (OCR, captioning –∏ —Ç.‚ÄØ–ø.), –∫–æ–≥–¥–∞
–º–æ–¥–µ–ª–∏ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã. –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–Ω–æ–µ
–æ–ø–∏—Å–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é.
"""

from __future__ import annotations

import time
from typing import Optional

# –ú–æ–¥—É–ª–∏ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ï—Å–ª–∏ mss
# –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É, –ø–æ–∑–≤–æ–ª—è—è –≤—ã–∑–æ–≤—É describe_screen,
# –Ω–æ run_screen_observer –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
try:
    import mss  # type: ignore[import]
except ImportError:
    mss = None  # type: ignore
try:
    from PIL import Image  # type: ignore[import]
except ImportError:
    # Pillow –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã –æ–ø–∏—Å–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–∞
    raise RuntimeError(
        "–î–ª—è –º–æ–¥—É–ª—è screen_capture —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Pillow (pip install pillow)"
    )

# –ò–º–ø–æ—Ä—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –∏ TTS. –ï—Å–ª–∏ –º–æ–¥—É–ª—å screen_capture –≤—Ö–æ–¥–∏—Ç –≤ –ø–∞–∫–µ—Ç
# services, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã. –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ–±—É–µ–º
# –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
try:
    from .llm import generate_response, USER_NAME  # type: ignore
    from .tts_silero import speak_text  # type: ignore
except ImportError:
    from llm import generate_response, USER_NAME  # type: ignore
    from tts_silero import speak_text  # type: ignore


def describe_screen(image: Image.Image) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.

    –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ä–µ–¥–Ω—é—é —è—Ä–∫–æ—Å—Ç—å –∏ –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏–π —Ü–≤–µ—Ç
    –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä
    "—Ç—ë–º–Ω—ã–π —ç–∫—Ä–∞–Ω" –∏–ª–∏ "—Å–≤–µ—Ç–ª—ã–π —ç–∫—Ä–∞–Ω —Å –ø—Ä–µ–æ–±–ª–∞–¥–∞–Ω–∏–µ–º —Å–∏–Ω–µ–≥–æ".
    –ï—Å–ª–∏ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ OCR –∏–ª–∏ captioning,
    —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å.

    :param image: —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ (PIL.Image)
    :return: –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    """
    # –ü—Ä–∏–≤–æ–¥–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ RGB –∏ –≤—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é —è—Ä–∫–æ—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤
    try:
        from PIL import ImageStat  # late import, Pillow —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    except Exception:
        # –ï—Å–ª–∏ Pillow –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ImageStat, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        return "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç–∫—Ä–∞–Ω–∞"
    # –£–º–µ–Ω—å—à–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    thumb = image.copy()
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 320 px –ø–æ –¥–ª–∏–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
    max_dim = max(thumb.width, thumb.height)
    if max_dim > 320:
        scale = 320 / max_dim
        new_size = (int(thumb.width * scale), int(thumb.height * scale))
        thumb = thumb.resize(new_size)
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —è—Ä–∫–æ—Å—Ç–∏
    stat = ImageStat.Stat(thumb)
    means = stat.mean  # —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–∞–Ω–∞–ª—É R,G,B
    brightness = sum(means) / 3.0
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏–π —Ü–≤–µ—Ç
    dominant_channel = max(enumerate(means), key=lambda x: x[1])[0]
    color_map = {0: "–∫—Ä–∞—Å–Ω–æ–≥–æ", 1: "–∑–µ–ª—ë–Ω–æ–≥–æ", 2: "—Å–∏–Ω–µ–≥–æ"}
    color_desc = color_map.get(dominant_channel, "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ")
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ —è—Ä–∫–æ—Å—Ç–∏
    if brightness < 50:
        bright_desc = "–æ—á–µ–Ω—å —Ç—ë–º–Ω—ã–π —ç–∫—Ä–∞–Ω"
    elif brightness < 100:
        bright_desc = "—Ç—ë–º–Ω—ã–π —ç–∫—Ä–∞–Ω"
    elif brightness < 180:
        bright_desc = "—Å–≤–µ—Ç–ª—ã–π —ç–∫—Ä–∞–Ω"
    else:
        bright_desc = "–æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —ç–∫—Ä–∞–Ω"
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–≤–µ—Ç–æ–≤–æ–º –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
    return f"{bright_desc} —Å –ø—Ä–µ–æ–±–ª–∞–¥–∞–Ω–∏–µ–º {color_desc} —Ü–≤–µ—Ç–∞"


def run_screen_observer(interval: float = 10.0, history: Optional[list[str]] = None) -> None:
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —ç–∫—Ä–∞–Ω–æ–º. –° –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å—é
    `interval` —Å–µ–∫—É–Ω–¥ –¥–µ–ª–∞–µ—Ç —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞, –æ–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ –∏
    –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —á–µ—Ä–µ–∑ LLM –∏ TTS.

    :param interval: –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–Ω–∏–º–∫–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    :param history: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–º–æ–∂–Ω–æ
        –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞)
    :return: None
    """
    if history is None:
        history = []
    if mss is None:
        # –ï—Å–ª–∏ mss –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã—Ö–æ–¥–∏–º
        print("‚ö†Ô∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ mss –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ —ç–∫—Ä–∞–Ω–æ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.")
        return
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º mss –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞
    with mss.mss() as sct:
        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä —Ü–µ–ª–∏–∫–æ–º
        monitor = sct.monitors[1]
        while True:
            # –ó–∞—Ö–≤–∞—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
            screenshot = sct.grab(monitor)
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ PIL.Image
            img = Image.frombytes('RGB', screenshot.size, screenshot.rgb)
            # –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            summary = describe_screen(img)
            print(f"üì∏ –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞: {summary}")
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –º–æ–¥–µ–ª–∏. –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ –∏–º–µ–Ω–∏
            prompt = (
                f"{USER_NAME}, —Å–µ–π—á–∞—Å –Ω–∞ —ç–∫—Ä–∞–Ω–µ: {summary}. "
                "–û–ø–∏—à–∏, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å, –∏ –¥–æ–±–∞–≤—å —Å–≤–æ—ë –∫—Ä–∞—Ç–∫–æ–µ –º–Ω–µ–Ω–∏–µ."
            )
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏
            response = generate_response(prompt, history)
            # –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            speak_text(response)
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (—Ö—Ä–∞–Ω–∏–º –Ω–µ –±–æ–ª–µ–µ 4 –∑–∞–ø–∏—Å–µ–π)
            entry = f"–≠–∫—Ä–∞–Ω: {summary}\n–≠–ª–µ–π–Ω-–°–∞–º–∞: {response}"
            history.append(entry)
            if len(history) > 4:
                history[:] = history[-4:]
            # –ñ–¥—ë–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
            time.sleep(interval)


if __name__ == "__main__":
    """
    –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ —ç–∫—Ä–∞–Ω–æ–º –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç.

    –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ñ–∞–π–ª–∞ screen_capture.py –Ω–∞–ø—Ä—è–º—É—é –±—É–¥–µ—Ç
    –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏—è run_screen_observer() —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –ø–æ
    —É–º–æ–ª—á–∞–Ω–∏—é. –≠—Ç–æ —É–¥–æ–±–Ω–æ –¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞
    —ç–∫—Ä–∞–Ω–æ–º, –∫–æ–≥–¥–∞ –≥–æ–ª–æ—Å–æ–≤–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
    """
    try:
        run_screen_observer()
    except KeyboardInterrupt:
        print("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —ç–∫—Ä–∞–Ω–æ–º –ø–æ Ctrl+C")