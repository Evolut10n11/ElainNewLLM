"""
–ú–æ–¥—É–ª—å –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å –ø–æ–º–æ—â—å—é LLM.

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ø–∞–∫–µ—Ç–∞ `services` –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥—Ä—É–≥–∏–º –º–æ–¥—É–ª—è–º —ç—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞.

–î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ `mss` –∏ `Pillow`. –í —Ü–∏–∫–ª–µ
—Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –¥–µ–ª–∞–µ—Ç —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞, –ø–µ—Ä–µ–¥–∞—ë—Ç –µ–≥–æ –≤ —Ñ—É–Ω–∫—Ü–∏—é
–æ–ø–∏—Å–∞–Ω–∏—è –∏ –∑–∞—Ç–µ–º –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –º–æ–¥–µ–ª–∏. –û–∑–≤—É—á–∏–≤–∞–µ—Ç
–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –ø–æ–º–æ—â—å—é —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–æ–¥—É–ª—è `tts_silero`.

–§—É–Ω–∫—Ü–∏—è `describe_screen` –ø–æ–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–æ–π. –ï—ë —Å–ª–µ–¥—É–µ—Ç
–∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (OCR, captioning –∏ —Ç.‚ÄØ–ø.), –∫–æ–≥–¥–∞
–º–æ–¥–µ–ª–∏ –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã. –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–Ω–æ–µ
–æ–ø–∏—Å–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é.
"""

from __future__ import annotations

import time
from typing import Optional

try:
    import mss  # type: ignore
    from PIL import Image  # type: ignore
except ImportError:
    # –ï—Å–ª–∏ mss –∏–ª–∏ Pillow –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
    raise RuntimeError(
        "–î–ª—è –º–æ–¥—É–ª—è screen_capture —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ mss –∏ Pillow (pip install mss pillow)"
    )

from .llm import generate_response, USER_NAME
from .tts_silero import speak_text


def describe_screen(image: Image.Image) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂—ë–Ω–Ω–æ–≥–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.

    –ù–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ
    —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–∑–¥–Ω–µ–µ —Å—é–¥–∞ –º–æ–∂–Ω–æ –≤—Å—Ç—Ä–æ–∏—Ç—å OCR –∏–ª–∏ captioning.

    :param image: —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ (PIL.Image)
    :return: –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
    """
    # TODO: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å –ø–æ–º–æ—â—å—é OCR –∏–ª–∏ –º–æ–¥–µ–ª–∏ captioning
    return "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç–∫—Ä–∞–Ω–∞"


def run_screen_observer(interval: float = 10.0, history: Optional[list[str]] = None) -> None:
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–∞ —ç–∫—Ä–∞–Ω–æ–º. –° –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å—é
    `interval` —Å–µ–∫—É–Ω–¥ –¥–µ–ª–∞–µ—Ç —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞, –æ–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ –∏
    –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —á–µ—Ä–µ–∑ LLM –∏ TTS.

    :param interval: –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–Ω–∏–º–∫–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    :param history: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–º–æ–∂–Ω–æ
        –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞)
    :return: None
    """
    if history is None:
        history = []
    with mss.mss() as sct:
        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä —Ü–µ–ª–∏–∫–æ–º
        monitor = sct.monitors[1]
        while True:
            # –ó–∞—Ö–≤–∞—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
            screenshot = sct.grab(monitor)
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ PIL.Image
            img = Image.frombytes('RGB', screenshot.size, screenshot.rgb)
            # –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            summary = describe_screen(img)
            print(f"üì∏ –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞: {summary}")
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –º–æ–¥–µ–ª–∏. –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ –∏–º–µ–Ω–∏
            prompt = (
                f"{USER_NAME}, —Å–µ–π—á–∞—Å –Ω–∞ —ç–∫—Ä–∞–Ω–µ: {summary}. "
                "–û–ø–∏—à–∏, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å, –∏ –¥–æ–±–∞–≤—å —Å–≤–æ—ë –∫—Ä–∞—Ç–∫–æ–µ –º–Ω–µ–Ω–∏–µ."
            )
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏
            response = generate_response(prompt, history)
            # –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            speak_text(response)
            # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (—Ö—Ä–∞–Ω–∏–º –Ω–µ –±–æ–ª–µ–µ 4 –∑–∞–ø–∏—Å–µ–π)
            entry = f"–≠–∫—Ä–∞–Ω: {summary}\n–≠–ª–µ–π–Ω-–°–∞–º–∞: {response}"
            history.append(entry)
            if len(history) > 4:
                history[:] = history[-4:]
            # –ñ–¥—ë–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
            time.sleep(interval)